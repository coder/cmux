{"version":3,"file":"fileCommon.js","sourceRoot":"","sources":["../../../src/services/tools/fileCommon.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAaA,sCAWC;AAWD,oCAEC;AAUD,8CAmBC;AAlED,+CAAiC;AAEjC,2CAA6B;AAC7B,+BAAmC;AAEnC;;;;;;;GAOG;AACH,SAAgB,aAAa,CAAC,KAAe;IAC3C,4CAA4C;IAC5C,MAAM,KAAK,GAAG,KAAK,CAAC,OAAO,IAAI,KAAK,CAAC,KAAK,CAAC,OAAO,EAAE,CAAC;IAErD,2EAA2E;IAC3E,qBAAqB;IACrB,MAAM,IAAI,GAAG,GAAG,KAAK,IAAI,KAAK,CAAC,IAAI,EAAE,CAAC;IAEtC,sEAAsE;IACtE,gCAAgC;IAChC,OAAO,MAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;AAC5E,CAAC;AAED;;;;;;;;GAQG;AACH,SAAgB,YAAY,CAAC,QAAgB,EAAE,UAAkB,EAAE,UAAkB;IACnF,OAAO,IAAA,kBAAW,EAAC,QAAQ,EAAE,UAAU,EAAE,UAAU,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,OAAO,EAAE,CAAC,EAAE,CAAC,CAAC;AAC/E,CAAC;AAED;;;;;;;GAOG;AACH,SAAgB,iBAAiB,CAAC,QAAgB,EAAE,GAAW;IAC7D,2DAA2D;IAC3D,MAAM,YAAY,GAAG,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC;QAC5C,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC;QACxB,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,EAAE,QAAQ,CAAC,CAAC;IAChC,MAAM,WAAW,GAAG,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;IAEtC,2EAA2E;IAC3E,8EAA8E;IAC9E,MAAM,YAAY,GAAG,IAAI,CAAC,QAAQ,CAAC,WAAW,EAAE,YAAY,CAAC,CAAC;IAE9D,6EAA6E;IAC7E,IAAI,YAAY,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,IAAI,CAAC,UAAU,CAAC,YAAY,CAAC,EAAE,CAAC;QACnE,OAAO;YACL,KAAK,EAAE,8DAA8D,GAAG,gBAAgB,QAAQ,iIAAiI;SAClO,CAAC;IACJ,CAAC;IAED,OAAO,IAAI,CAAC;AACd,CAAC","sourcesContent":["import * as crypto from \"crypto\";\nimport type * as fs from \"fs\";\nimport * as path from \"path\";\nimport { createPatch } from \"diff\";\n\n/**\n * Compute a 6-character hexadecimal lease from file stats.\n * The lease changes when file is modified (mtime or size changes).\n * Uses a deterministic hash so leases are consistent across processes.\n *\n * @param stats - File stats from fs.stat()\n * @returns 6-character hexadecimal lease string\n */\nexport function leaseFromStat(stats: fs.Stats): string {\n  // Use highest-precision timestamp available\n  const mtime = stats.mtimeMs ?? stats.mtime.getTime();\n\n  // We use size in case mtime is only second precision, which occurs on some\n  // dated filesystems.\n  const data = `${mtime}:${stats.size}`;\n\n  // Use deterministic SHA-256 hash (no secret) so leases are consistent\n  // across processes and restarts\n  return crypto.createHash(\"sha256\").update(data).digest(\"hex\").slice(0, 6);\n}\n\n/**\n * Generate a unified diff between old and new content using jsdiff.\n * Uses createPatch with context of 3 lines.\n *\n * @param filePath - The file path being edited (used in diff header)\n * @param oldContent - The original file content\n * @param newContent - The modified file content\n * @returns Unified diff string\n */\nexport function generateDiff(filePath: string, oldContent: string, newContent: string): string {\n  return createPatch(filePath, oldContent, newContent, \"\", \"\", { context: 3 });\n}\n\n/**\n * Validates that a file path is within the allowed working directory.\n * Returns an error object if the path is outside cwd, null if valid.\n *\n * @param filePath - The file path to validate (can be relative or absolute)\n * @param cwd - The working directory that file operations are restricted to\n * @returns Error object if invalid, null if valid\n */\nexport function validatePathInCwd(filePath: string, cwd: string): { error: string } | null {\n  // Resolve the path (handles relative paths and normalizes)\n  const resolvedPath = path.isAbsolute(filePath)\n    ? path.resolve(filePath)\n    : path.resolve(cwd, filePath);\n  const resolvedCwd = path.resolve(cwd);\n\n  // Check if resolved path starts with cwd (accounting for trailing slashes)\n  // Use path.relative to check if we need to go \"up\" from cwd to reach the file\n  const relativePath = path.relative(resolvedCwd, resolvedPath);\n\n  // If the relative path starts with '..' or is empty, the file is outside cwd\n  if (relativePath.startsWith(\"..\") || path.isAbsolute(relativePath)) {\n    return {\n      error: `File operations are restricted to the workspace directory (${cwd}). The path '${filePath}' resolves outside this directory. If you need to modify files outside the workspace, please ask the user for permission first.`,\n    };\n  }\n\n  return null;\n}\n"]}
#!/usr/bin/env node

/**
 * Simple script to inline IPC constants into the preload script.
 * This solves the Electron sandbox module resolution issue.
 */

const fs = require("fs");
const path = require("path");

// Paths
const constantsPath = path.join(__dirname, "..", "dist", "constants", "ipc-constants.js");
const preloadPath = path.join(__dirname, "..", "dist", "preload.js");

try {
  // Read the constants file
  let constantsContent = fs.readFileSync(constantsPath, "utf8");

  // Remove the module.exports line since we'll inline the content
  constantsContent = constantsContent.replace(/module\.exports\s*=\s*{[\s\S]*?};?\s*$/, "");

  // Read the preload file
  let preloadContent = fs.readFileSync(preloadPath, "utf8");

  // Replace the require statement with the inlined constants
  // The require line looks like: const { IPC_CHANNELS, getOutputChannel, getClearChannel } = require("./constants/ipc-constants.js");
  preloadContent = preloadContent.replace(
    /const\s*{\s*IPC_CHANNELS,\s*getOutputChannel,\s*getClearChannel\s*}\s*=\s*require\([^)]+\);/,
    `// Inlined IPC constants (generated by inline-preload-constants.js)
${constantsContent}`
  );

  // Write the modified preload file
  fs.writeFileSync(preloadPath, preloadContent, "utf8");

  console.log("✅ Successfully inlined IPC constants into preload.js");
} catch (error) {
  console.error("❌ Failed to inline constants:", error.message);
  process.exit(1);
}
